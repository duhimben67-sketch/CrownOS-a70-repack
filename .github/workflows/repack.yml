name: Repack CrownOS (LineageOS 20 base, A705FN)

on:
  workflow_dispatch:

jobs:
  repack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install tools & python dependencies
        run: |
          sudo apt update
          sudo apt install -y zip unzip rsync python3-pip
          pip3 install pillow

      - name: Download base ROM from release asset
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # The base zip must be uploaded to Releases as 'lineage-base.zip'
          # This finds the latest release asset named lineage-base.zip and downloads it.
          python3 - <<'PY'
import os,sys,requests
owner_repo = os.environ['REPO']
token = os.environ['TOKEN']
api = f"https://api.github.com/repos/{owner_repo}/releases/latest"
h = {'Authorization': f'token {token}', 'Accept': 'application/vnd.github.v3+json'}
r = requests.get(api, headers=h)
if r.status_code != 200:
    print("No release found. Make a release and upload lineage-base.zip as an asset."); sys.exit(1)
assets = r.json().get('assets',[])
for a in assets:
    if a.get('name')=='lineage-base.zip':
        url = a.get('url')
        print("Found asset, downloading...")
        dl = requests.get(url, headers={**h, 'Accept':'application/octet-stream'}, stream=True)
        open('lineage-base.zip','wb').write(dl.content)
        print("Downloaded lineage-base.zip")
        sys.exit(0)
print("No asset named lineage-base.zip in latest release. Please upload it."); sys.exit(1)
PY

      - name: Unpack base ROM
        run: |
          rm -rf work
          mkdir -p work
          unzip -q lineage-base.zip -d work
          echo "Unpacked base into work/"

      - name: Copy user modifications (APK/fonts/bootanimation)
        run: |
          # copy system app apks if provided
          if [ -d "modifications/system/app" ]; then
            mkdir -p work/system/app
            cp -r modifications/system/app/* work/system/app/ || true
          fi
          # copy fonts
          if [ -d "modifications/system/fonts" ]; then
            mkdir -p work/system/fonts
            cp -r modifications/system/fonts/* work/system/fonts/ || true
          fi
          # copy a pre-made bootanimation.zip in repo if supplied
          if [ -f "modifications/media/bootanimation.zip" ]; then
            mkdir -p work/system/media
            cp modifications/media/bootanimation.zip work/system/media/bootanimation.zip
          fi

      - name: Generate bootanimation if not provided (grey crown)
        run: |
          if [ ! -f "work/system/media/bootanimation.zip" ]; then
            python3 scripts/generate_bootanimation.py work
            echo "Generated bootanimation.zip"
          else
            echo "Using provided bootanimation.zip"
          fi

      - name: Apply heavy CrownOS tweaks
        run: |
          chmod +x scripts/apply_tweaks.sh
          scripts/apply_tweaks.sh work

      - name: Fix file permissions
        run: |
          find work -type d -exec chmod 755 {} \;
          find work -type f -exec chmod 644 {} \;

      - name: Repack CrownOS ZIP
        run: |
          mkdir -p output
          cd work
          zip -r9 ../output/CrownOS-A70-smooth.zip ./*
          cd ..
          ls -lh output/CrownOS-A70-smooth.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CrownOS-A70-smooth
          path: output/CrownOS-A70-smooth.zip
